<mat-card class="takeon-card">
  <div class="page-wrapper">
    <!-- LEFT SIDEBAR -->
    <aside class="left-nav">
      <div class="steps-list">
        <div class="step active">
          <div class="bullet">1</div>
          <div class="label">How did you hear about us?</div>
        </div>
        <div class="step">
          <div class="bullet">2</div>
          <div class="label">Your personal details</div>
        </div>
        <div class="step">
          <div class="bullet">3</div>
          <div class="label">Select product/s</div>
        </div>
        <div class="step">
          <div class="bullet">4</div>
          <div class="label">Payment details</div>
        </div>
        <div class="step">
          <div class="bullet">5</div>
          <div class="label">Your financial details</div>
        </div>
        <div class="step">
          <div class="bullet">6</div>
          <div class="label">Confirm</div>
        </div>
      </div>
    </aside>

    <!-- MAIN AREA -->
    <section class="main-area">
      <h2 class="page-title">Take-on Form</h2>
      <br />
      <p class="hint">Welcome to FinLaw SA. Please enter your details below. Click Next/Back to navigate.</p>

      <form [formGroup]="form" (ngSubmit)="submit()">
        <mat-horizontal-stepper #stepper linear>
          <!-- STEP 1 -->
          <mat-step [stepControl]="step1Group">
            <div [formGroup]="step1Group" class="step-form">
              <ng-template matStepLabel>1: How did you hear about us?</ng-template>

              <mat-form-field appearance="outline" class="full">
                <mat-label>How did you hear about us?</mat-label>
                <mat-select formControlName="howDidYouHear">
                  <mat-option value="">Select</mat-option>
                  <mat-option *ngFor="let o of howOptions" [value]="o.value">{{ o.label }}</mat-option>
                </mat-select>
              </mat-form-field>

              <div class="affiliate-section" *ngIf="step1Group.get('howDidYouHear')?.value === 'referral'">
                <h3>Affiliate details</h3>
                <br />

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Affiliate</mat-label>
                  <mat-select formControlName="affiliate">
                    <mat-option value="">Select</mat-option>
                    <mat-option *ngFor="let o of affiliateOptions" [value]="o.value">{{ o.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="actions">
                <button mat-stroked-button type="button" (click)="saveDraft()">Save</button>
                <button mat-raised-button color="primary" matStepperNext [disabled]="step1Group.invalid">Next</button>
              </div>
            </div>
          </mat-step>

          <!-- STEP 2 -->
          <mat-step [stepControl]="step2Group">
            <ng-template matStepLabel>2: Your personal details</ng-template>

            <div class="step-content grid-2">
              <!-- LEFT COLUMN -->
              <div class="column" [formGroup]="personalGroup">
                <mat-form-field appearance="outline" class="small">
                  <mat-label>Title</mat-label>
                  <mat-select formControlName="title">
                    <mat-option *ngFor="let t of titleOptions" [value]="t.value">{{ t.label }}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Surname</mat-label>
                  <input matInput formControlName="surname" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>First Names</mat-label>
                  <input matInput formControlName="firstNames" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="small">
                  <mat-label>Initials</mat-label>
                  <input matInput formControlName="initials" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>ID Number</mat-label>
                  <input matInput formControlName="idNumber" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Marital Status</mat-label>
                  <mat-select formControlName="maritalStatus">
                    <mat-option value="single">Single</mat-option>
                    <mat-option value="married">Married</mat-option>
                    <mat-option value="divorced">Divorced</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Language</mat-label>
                  <mat-select formControlName="language">
                    <mat-option value="en">English</mat-option>
                    <mat-option value="af">Afrikaans</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Gender</mat-label>
                  <mat-select formControlName="gender">
                    <mat-option value="male">Male</mat-option>
                    <mat-option value="female">Female</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Occupation</mat-label>
                  <input matInput formControlName="occupation" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Employer</mat-label>
                  <input matInput formControlName="employer" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Employer Address</mat-label>
                  <input matInput formControlName="employerAddress" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Province</mat-label>
                  <mat-select formControlName="province">
                    <mat-option *ngFor="let p of provinceOptions" [value]="p.value">{{ p.label }}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>City</mat-label>
                  <mat-select formControlName="city">
                    <mat-option *ngFor="let c of cityOptions" [value]="c.value">{{ c.label }}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="small">
                  <mat-label>Code</mat-label>
                  <input matInput formControlName="code" />
                </mat-form-field>
              </div>

              <!-- BANK GROUP -->
              <div class="bank-block" [formGroup]="bankGroup">
                <h3>Bank details</h3>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Account Owner</mat-label>
                  <input matInput formControlName="accountOwner" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Bank Name</mat-label>
                  <mat-select formControlName="bankName">
                    <mat-option *ngFor="let b of bankOptions" [value]="b.value">{{ b.label }}</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Account Number</mat-label>
                  <input matInput formControlName="accountNo" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Account Type</mat-label>
                  <mat-select formControlName="accountType">
                    <mat-option value="cheque">Cheque</mat-option>
                    <mat-option value="savings">Savings</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- RIGHT COLUMN -->
              <div class="column right-col" [formGroup]="personalGroup">
                <mat-form-field appearance="outline" class="full">
                  <mat-label>Home Address</mat-label>
                  <input matInput formControlName="homeAddress" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label></mat-label>
                  <input matInput disabled />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Postal Address</mat-label>
                  <textarea matInput rows="4" formControlName="postalAddress"></textarea>
                </mat-form-field>

                <mat-form-field appearance="outline" class="small">
                  <mat-label>Tel (Work)</mat-label>
                  <input matInput formControlName="telWork" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="small">
                  <mat-label>Tel (Home)</mat-label>
                  <input matInput formControlName="telHome" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="small">
                  <mat-label>Cell</mat-label>
                  <input matInput formControlName="cell" />
                </mat-form-field>

                <mat-checkbox formControlName="whatsappSameAsCell"> WhatsApp number same as Cell </mat-checkbox>

                <mat-form-field appearance="outline" class="small">
                  <mat-label>WhatsApp</mat-label>
                  <input matInput formControlName="whatsapp" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Tel Next of Kin</mat-label>
                  <input matInput formControlName="telNextOfKin" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                  <mat-label>Email</mat-label>
                  <input matInput formControlName="email" type="email" />
                </mat-form-field>

                <div class="credit-check">
                  <label>Do you authorize FinLaw SA to do a credit check?</label>
                  <mat-form-field appearance="outline" class="small">
                    <mat-select formControlName="authorizeCreditCheck">
                      <mat-option value="yes">Yes</mat-option>
                      <mat-option value="no">No</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <div class="actions">
              <button mat-stroked-button (click)="previous(stepper)">Back</button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="step2Group.invalid">Next</button>
            </div>
          </mat-step>

          <!-- STEP 3 (NO STEP CONTROL ANYMORE — FIX FOR SKIPPING) -->
          <mat-step>
            <ng-template matStepLabel>3: Select product/s</ng-template>

            <div class="step-content products-area">
              <!-- LEFT SIDE PRODUCT LIST -->
              <div class="products-list" formArrayName="products">
                <div *ngFor="let pCtrl of productsArray.controls; let i = index" [formGroupName]="i" class="product-row">
                  <mat-checkbox formControlName="selected" class="product-checkbox">
                    <span class="product-title">{{ productOptions[i].title }}</span>
                  </mat-checkbox>

                  <div class="product-desc">{{ productOptions[i].description }}</div>

                  <mat-divider></mat-divider>
                </div>
              </div>

              <!-- RIGHT SIDE DETAILS PANEL -->
              <div class="product-details" *ngIf="hasSelectedProducts">
                <h3>Product-Specific Information</h3>

                <div *ngFor="let pCtrl of productsArray.controls; let idx = index">
                  <ng-container [formGroup]="pCtrl.get('productInfo')" *ngIf="pCtrl.get('selected')?.value">
                    <mat-card class="product-card">
                      <mat-card-title>{{ productOptions[idx].title }}</mat-card-title>
                      <mat-card-content>
                        <!-- CONDITIONAL UI PER PRODUCT -->
                        <div *ngIf="productOptions[idx].id === 'B_LEGAL_ASSESS'">
                          <div class="two-col-fields">
                            <mat-form-field appearance="outline" class="small">
                              <mat-label>Gross Salary</mat-label>
                              <input matInput type="number" formControlName="grossSalary" />
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="small">
                              <mat-label>Net Salary</mat-label>
                              <input matInput type="number" formControlName="netSalary" />
                            </mat-form-field>
                          </div>
                        </div>

                        <div *ngIf="productOptions[idx].id === 'NEGOTIATION'">
                          <mat-form-field appearance="outline" class="full">
                            <mat-label>Negotiation Type</mat-label>
                            <mat-select formControlName="negotiationType">
                              <mat-option value="judgement">Judgement</mat-option>
                              <mat-option value="default">Default</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>

                        <!-- fallback notes -->
                        <div *ngIf="productOptions[idx].id !== 'B_LEGAL_ASSESS' && productOptions[idx].id !== 'NEGOTIATION'">
                          <mat-form-field appearance="outline" class="full">
                            <mat-label>Notes</mat-label>
                            <textarea matInput rows="3" formControlName="notes"></textarea>
                          </mat-form-field>
                        </div>
                      </mat-card-content>
                    </mat-card>
                  </ng-container>
                </div>
              </div>
            </div>

            <div class="actions">
              <button mat-stroked-button (click)="previous(stepper)">Back</button>
              <button mat-stroked-button type="button" (click)="saveDraft()">Save</button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="!hasSelectedProducts">Next</button>
            </div>
          </mat-step>

          <!-- STEP 4: PAYMENT DETAILS -->
          <mat-step [stepControl]="paymentGroup">
            <ng-template matStepLabel>4: Payment details</ng-template>

            <p class="section-title">Please select a payment option:</p>

            <div [formGroup]="paymentGroup" class="payment-select-row">
              <div class="pay-left">
                <label class="heading">Product / Payment option</label>

                <mat-form-field appearance="outline" class="payment-dropdown">
                  <mat-select formControlName="option">
                    <mat-option value="debit"> Once-off payment: R 1,000.00 (Debit order) </mat-option>
                    <mat-option value="cash"> Once-off payment: R 1,000.00 (Cash) </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="pay-right">
                <label class="heading">First payment</label>

                <mat-form-field appearance="outline" class="payment-dropdown">
                  <mat-select formControlName="firstPayment">
                    <mat-option value="first">First month</mat-option>
                    <mat-option value="second">Second month</mat-option>
                    <mat-option value="third">Third month</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- QUOTE TABLE -->
            <h3 class="quote-title">Here is a quote of your selected products:</h3>

            <table class="quote-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Once-off payments</th>
                  <th>Monthly payments</th>
                  <th>Months</th>
                  <th>First payment</th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td>Total debit order payments</td>
                  <td>R 1,000.00</td>
                  <td>-</td>
                  <td>-</td>
                  <td>
                    {{ paymentGroup.get('firstPayment')?.value === 'first' ? 'First month' : paymentGroup.get('firstPayment')?.value === 'second' ? 'Second month' : 'Third month' }}
                  </td>
                </tr>
              </tbody>
            </table>

            <pre class="payment-description"
              >{{ getPaymentDescription(paymentGroup.get('option')?.value) }}
            </pre>

            <div class="actions">
              <button mat-stroked-button (click)="previous(stepper)">Back</button>
              <button mat-stroked-button type="button" (click)="saveDraft()">Save</button>
              <button mat-raised-button color="primary" matStepperNext>Next</button>
            </div>
          </mat-step>

          <!-- STEP 5: FINANCIAL DETAILS (SALARY) -->
          <mat-step [stepControl]="salaryGroup">
            <ng-template matStepLabel>5: Your financial details</ng-template>

            <div class="step-content salary-step" [formGroup]="salaryGroup">
              <h3>Salary</h3>
              <p class="hint">Please enter the following details regarding your monthly salary.</p>

              <!-- Gross salary -->
              <div class="salary-row">
                <label class="salary-label"> What is your gross monthly salary? </label>

                <mat-form-field appearance="outline" class="salary-input">
                  <span matPrefix>R&nbsp;</span>
                  <input matInput type="number" formControlName="grossSalary" placeholder="0.00" />
                  <mat-error *ngIf="salaryGroup.get('grossSalary')?.hasError('required')"> Gross salary is required </mat-error>
                </mat-form-field>
              </div>

              <!-- Pay day -->
              <div class="salary-row">
                <label class="salary-label"> Which day of the month do you get paid? </label>

                <mat-form-field appearance="outline" class="salary-input">
                  <mat-select formControlName="payDay">
                    <mat-option value="">Select</mat-option>
                    <mat-option *ngFor="let d of payDayOptions" [value]="d">
                      {{ d }}
                    </mat-option>
                  </mat-select>

                  <mat-error *ngIf="salaryGroup.get('payDay')?.hasError('required')"> Please select a pay day </mat-error>
                </mat-form-field>
              </div>

              <!-- Debit day -->
              <div class="salary-row">
                <label class="salary-label"> If applicable, payment instructions due in December and/or April may be debited against your account on which day of the month? </label>

                <mat-form-field appearance="outline" class="salary-input">
                  <mat-select formControlName="debitDay">
                    <mat-option value="">Select</mat-option>
                    <mat-option *ngFor="let d of payDayOptions" [value]="d">
                      {{ d }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <div class="actions">
              <button mat-stroked-button type="button" (click)="previous(stepper)">Back</button>
              <button mat-stroked-button type="button" (click)="saveDraft()">Save</button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="salaryGroup.invalid">Next</button>
            </div>
          </mat-step>

          <!-- STEP 6: CONFIRM -->
          <!-- STEP 6: CONFIRM -->
          <mat-step>
            <ng-template matStepLabel>6: Confirm</ng-template>

            <div class="confirm-summary">
              <h3 class="confirm-title">Confirm your details</h3>
              <p class="hint">Please review the information below carefully before submitting.</p>

              <!-- STEP 1 SUMMARY -->
              <mat-card class="summary-card">
                <mat-card-title>How did you hear about us?</mat-card-title>
                <mat-card-content>
                  <p><strong>Source:</strong> {{ step1Group.value.howDidYouHear || '—' }}</p>
                  <p *ngIf="step1Group.value.affiliate"><strong>Affiliate:</strong> {{ step1Group.value.affiliate }}</p>
                  <p *ngIf="step1Group.value.affiliateNotes"><strong>Notes:</strong> {{ step1Group.value.affiliateNotes }}</p>
                </mat-card-content>
              </mat-card>

              <!-- PERSONAL DETAILS -->
              <mat-card class="summary-card">
                <mat-card-title>Personal details</mat-card-title>
                <mat-card-content class="summary-grid">
                  <p><strong>Name:</strong> {{ personalGroup.value.title }} {{ personalGroup.value.firstNames }} {{ personalGroup.value.surname }}</p>
                  <p><strong>ID Number:</strong> {{ personalGroup.value.idNumber }}</p>
                  <p><strong>Gender:</strong> {{ personalGroup.value.gender }}</p>
                  <p><strong>Marital status:</strong> {{ personalGroup.value.maritalStatus }}</p>
                  <p><strong>Language:</strong> {{ personalGroup.value.language }}</p>
                  <p><strong>Cell:</strong> {{ personalGroup.value.cell }}</p>
                  <p><strong>Email:</strong> {{ personalGroup.value.email || '—' }}</p>
                  <p><strong>Address:</strong> {{ personalGroup.value.homeAddress }}</p>
                  <p><strong>Province:</strong> {{ personalGroup.value.province }}</p>
                  <p><strong>City:</strong> {{ personalGroup.value.city }}</p>
                </mat-card-content>
              </mat-card>

              <!-- BANK DETAILS -->
              <mat-card class="summary-card">
                <mat-card-title>Bank details</mat-card-title>
                <mat-card-content>
                  <p><strong>Account owner:</strong> {{ bankGroup.value.accountOwner }}</p>
                  <p><strong>Bank:</strong> {{ bankGroup.value.bankName }}</p>
                  <p><strong>Account number:</strong> {{ bankGroup.value.accountNo }}</p>
                  <p><strong>Account type:</strong> {{ bankGroup.value.accountType }}</p>
                </mat-card-content>
              </mat-card>

              <!-- PRODUCTS -->
              <mat-card class="summary-card">
                <mat-card-title>Selected products</mat-card-title>
                <mat-card-content>
                  <ul class="summary-list">
                    <li *ngFor="let p of productsArray.value">
                      <span *ngIf="p.selected">
                        {{ getProductTitle(p.id) }}
                      </span>
                    </li>
                  </ul>
                </mat-card-content>
              </mat-card>

              <!-- PAYMENT -->
              <mat-card class="summary-card">
                <mat-card-title>Payment details</mat-card-title>
                <mat-card-content>
                  <p>
                    <strong>Payment option:</strong>
                    {{ paymentGroup.value.option === 'debit' ? 'Once-off payment: R 1,000.00 (Debit order)' : 'Once-off payment: R 1,000.00 (Cash)' }}
                  </p>
                  <p>
                    <strong>First payment:</strong>
                    {{ paymentGroup.value.firstPayment === 'first' ? 'First month' : paymentGroup.value.firstPayment === 'second' ? 'Second month' : 'Third month' }}
                  </p>
                </mat-card-content>
              </mat-card>

              <!-- SALARY -->
              <mat-card class="summary-card">
                <mat-card-title>Financial details</mat-card-title>
                <mat-card-content>
                  <p><strong>Gross salary:</strong> R {{ salaryGroup.value.grossSalary }}</p>
                  <p><strong>Pay day:</strong> {{ salaryGroup.value.payDay }}</p>
                  <p *ngIf="salaryGroup.value.debitDay"><strong>Debit day:</strong> {{ salaryGroup.value.debitDay }}</p>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- ACTIONS -->
            <div class="actions">
              <button mat-stroked-button type="button" (click)="previous(stepper)">Back</button>
              <button mat-raised-button color="primary" type="submit">Confirm & Submit</button>
            </div>
          </mat-step>
        </mat-horizontal-stepper>
      </form>
    </section>
  </div>
</mat-card>
